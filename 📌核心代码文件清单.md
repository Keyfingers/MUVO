# ğŸ“Œ MUVOé¡¹ç›®æ ¸å¿ƒä»£ç æ–‡ä»¶æ¸…å•

> **ä¾›Sparkå¤§äººå’Œå¯¼å¸ˆreviewä½¿ç”¨**

---

## ğŸ¯ ä¸€çº§æ ¸å¿ƒæ–‡ä»¶ (æœ€é‡è¦ï¼Œå¿…çœ‹)

### 1. æ¨¡å‹æ¶æ„æ ¸å¿ƒ â­â­â­â­â­

#### `muvo/models/mile_anomaly.py`
**å½±å“èŒƒå›´**: æ•´ä¸ªç³»ç»Ÿæ¶æ„
**å…³é”®å†…å®¹**:
- âœ… ä¸»æ¨¡å‹ `MILEAnomaly` ç±»å®šä¹‰
- âœ… å›¾åƒç¼–ç å™¨ (ResNet18)
- âœ… ç‚¹äº‘ç¼–ç å™¨ (Point Pillar / Range View)
- âœ… è·¨æ¨¡æ€èåˆé€»è¾‘
- âœ… å¼‚å¸¸æ£€æµ‹å¤´é›†æˆ

**ä¸ºä»€ä¹ˆé‡è¦**:
- è¿™æ˜¯æ•´ä¸ªç³»ç»Ÿçš„"å¤§è„‘"
- å†³å®šäº†æ¨¡å‹å¦‚ä½•å¤„ç†å›¾åƒå’Œç‚¹äº‘æ•°æ®
- åŒ…å«äº†æ‚¨è®ºæ–‡çš„æ ¸å¿ƒåˆ›æ–°ï¼ˆè·¨æ¨¡æ€æ³¨æ„åŠ›èåˆï¼‰

**è·¯å¾„**: `/root/autodl-tmp/MUVO/MUVO/muvo/models/mile_anomaly.py`

---

#### `muvo/models/cross_modal_attention.py`
**å½±å“èŒƒå›´**: æ ¸å¿ƒåˆ›æ–°ç‚¹
**å…³é”®å†…å®¹**:
- âœ… `CrossModalAttention` ç±» - è·¨æ¨¡æ€æ³¨æ„åŠ›æœºåˆ¶
- âœ… `PositionalEncoding3D` ç±» - 3Dä½ç½®ç¼–ç 
- âœ… `FeatureAlignment` ç±» - ç‰¹å¾å¯¹é½æ–¹æ³•

**ä¸ºä»€ä¹ˆé‡è¦**:
- **è¿™æ˜¯æ‚¨è®ºæ–‡çš„æ ¸å¿ƒåˆ›æ–°ï¼**
- å®ç°äº†å›¾åƒå’Œç‚¹äº‘çš„æ³¨æ„åŠ›èåˆ
- ä¸‰ç§ç‰¹å¾å¯¹é½æ–¹æ³•ï¼ˆnearest, bilinear, networkï¼‰

**è·¯å¾„**: `/root/autodl-tmp/MUVO/MUVO/muvo/models/cross_modal_attention.py`

---

### 2. æ•°æ®å¤„ç†æ ¸å¿ƒ â­â­â­â­â­

#### `muvo/dataset/anovox_dataset.py`
**å½±å“èŒƒå›´**: æ•°æ®åŠ è½½å’Œå¤„ç†
**å…³é”®å†…å®¹**:
- âœ… `AnoVoxDataset` ç±» - AnoVoxæ•°æ®åŠ è½½å™¨
- âœ… `collate_fn` å‡½æ•° - å¤„ç†å˜é•¿ç‚¹äº‘
- âœ… å›¾åƒé¢„å¤„ç† (resize, normalize)
- âœ… ç‚¹äº‘é¢„å¤„ç† (load .npy, add intensity)
- âœ… ä½“ç´ æ ‡ç­¾åŠ è½½

**ä¸ºä»€ä¹ˆé‡è¦**:
- å†³å®šäº†æ¨¡å‹èƒ½"çœ‹åˆ°"ä»€ä¹ˆæ•°æ®
- å¤„ç†äº†AnoVoxæ•°æ®é›†çš„ç‰¹æ®Šæ ¼å¼
- è§£å†³äº†å˜é•¿ç‚¹äº‘çš„batchingé—®é¢˜

**è·¯å¾„**: `/root/autodl-tmp/MUVO/MUVO/muvo/dataset/anovox_dataset.py`

---

### 3. é…ç½®æ ¸å¿ƒ â­â­â­â­

#### `muvo/config.py`
**å½±å“èŒƒå›´**: å…¨å±€é…ç½®
**å…³é”®å†…å®¹**:
- âœ… æ‰€æœ‰æ¨¡å‹å‚æ•°é…ç½®
- âœ… è®­ç»ƒè¶…å‚æ•°é…ç½®
- âœ… æ•°æ®é›†é…ç½®
- âœ… å¼‚å¸¸æ£€æµ‹é…ç½® (`MODEL.ANOMALY_DETECTION`)

**ä¸ºä»€ä¹ˆé‡è¦**:
- æ§åˆ¶æ•´ä¸ªç³»ç»Ÿçš„è¡Œä¸º
- ä¿®æ”¹è¿™é‡Œå¯ä»¥è°ƒæ•´æ‰€æœ‰è¶…å‚æ•°
- æ¶ˆèå®éªŒçš„é…ç½®ä¹Ÿåœ¨è¿™é‡Œ

**è·¯å¾„**: `/root/autodl-tmp/MUVO/MUVO/muvo/config.py`

---

## ğŸ”§ äºŒçº§æ ¸å¿ƒæ–‡ä»¶ (é‡è¦ï¼Œéœ€è¦ç†è§£)

### 4. è®­ç»ƒè„šæœ¬

#### âœ… `train_with_focal_loss.py` (æœ€æ–°ï¼Œä½¿ç”¨Focal Loss)
**å½±å“èŒƒå›´**: è®­ç»ƒæµç¨‹
**å…³é”®å†…å®¹**:
- âœ… `ImprovedAnomalyDetector` ç±» - æ”¹è¿›çš„æ£€æµ‹å™¨
- âœ… `FocalLoss` ç±» - è§£å†³ç±»åˆ«ä¸å¹³è¡¡
- âœ… é¢„è®­ç»ƒResNet18é›†æˆ
- âœ… è®­ç»ƒå¾ªç¯å’Œä¼˜åŒ–å™¨è®¾ç½®
- âœ… å­¦ä¹ ç‡è°ƒåº¦

**è·¯å¾„**: `/root/autodl-tmp/MUVO/MUVO/train_with_focal_loss.py`

---

#### âš ï¸ `train_anomaly_with_labels.py` (ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œæœ‰é—®é¢˜)
**å½±å“èŒƒå›´**: ä¹‹å‰çš„è®­ç»ƒæµç¨‹
**é—®é¢˜**: ä½¿ç”¨æ ‡å‡†BCE Lossï¼Œå¯¼è‡´æ¨¡å‹"æŠ•æœºå–å·§"
**çŠ¶æ€**: å·²è¢« `train_with_focal_loss.py` æ›¿ä»£

**è·¯å¾„**: `/root/autodl-tmp/MUVO/MUVO/train_anomaly_with_labels.py`

---

### 5. è¯„ä¼°è„šæœ¬

#### `evaluate_focal_loss.py`
**å½±å“èŒƒå›´**: æ¨¡å‹è¯„ä¼°
**å…³é”®å†…å®¹**:
- âœ… è®¡ç®—AUROC, AUPRC, Precision, Recall
- âœ… ç”ŸæˆROCæ›²çº¿å’ŒPRæ›²çº¿
- âœ… æ··æ·†çŸ©é˜µåˆ†æ
- âœ… å¯¹æ¯”å¯è§†åŒ–

**è·¯å¾„**: `/root/autodl-tmp/MUVO/MUVO/evaluate_focal_loss.py`

---

### 6. å…¶ä»–æ¨¡å‹ç»„ä»¶

#### `muvo/models/common.py`
**å½±å“èŒƒå›´**: é€šç”¨æ¨¡å—
**å…³é”®å†…å®¹**:
- âœ… `RouteEncode` - è·¯çº¿å›¾ç¼–ç å™¨
- âœ… `SpatialBroadcastDecoder` - ç©ºé—´å¹¿æ’­è§£ç å™¨
- âœ… å…¶ä»–é€šç”¨ç½‘ç»œå±‚

**è·¯å¾„**: `/root/autodl-tmp/MUVO/MUVO/muvo/models/common.py`

---

## ğŸ“Š ä¸‰çº§æ–‡ä»¶ (è¾…åŠ©åŠŸèƒ½)

### 7. ç›‘æ§å’Œå¯è§†åŒ–

#### `monitor_training.py`
**åŠŸèƒ½**: å®æ—¶ç›‘æ§è®­ç»ƒè¿›åº¦
**è·¯å¾„**: `/root/autodl-tmp/MUVO/MUVO/monitor_training.py`

#### `visualize_training.py`
**åŠŸèƒ½**: è®­ç»ƒç»“æœå¯è§†åŒ–
**è·¯å¾„**: `/root/autodl-tmp/MUVO/MUVO/visualize_training.py`

---

### 8. æµ‹è¯•è„šæœ¬

#### `test_anomaly_detection.py`
**åŠŸèƒ½**: æµ‹è¯•æ¨¡å‹å„ç»„ä»¶
**è·¯å¾„**: `/root/autodl-tmp/MUVO/MUVO/test_anomaly_detection.py`

---

## ğŸ“ ç»™å¯¼å¸ˆçš„æ ¸å¿ƒä»£ç é˜…è¯»é¡ºåº

### ç¬¬ä¸€æ­¥ï¼šç†è§£æ ¸å¿ƒåˆ›æ–° (15åˆ†é’Ÿ)
```
1. muvo/models/cross_modal_attention.py
   â†’ æŸ¥çœ‹ CrossModalAttention ç±» (ç¬¬80-150è¡Œ)
   â†’ è¿™æ˜¯è®ºæ–‡çš„æ ¸å¿ƒåˆ›æ–°ç‚¹
```

### ç¬¬äºŒæ­¥ï¼šç†è§£æ•´ä½“æ¶æ„ (20åˆ†é’Ÿ)
```
2. muvo/models/mile_anomaly.py
   â†’ æŸ¥çœ‹ MILEAnomaly ç±»çš„ __init__ (ç¬¬50-150è¡Œ)
   â†’ æŸ¥çœ‹ forward å‡½æ•° (ç¬¬200-300è¡Œ)
   â†’ ç†è§£æ•°æ®å¦‚ä½•æµç»æ¨¡å‹
```

### ç¬¬ä¸‰æ­¥ï¼šç†è§£æ•°æ®å¤„ç† (10åˆ†é’Ÿ)
```
3. muvo/dataset/anovox_dataset.py
   â†’ æŸ¥çœ‹ __getitem__ å‡½æ•° (ç¬¬150-200è¡Œ)
   â†’ æŸ¥çœ‹ collate_fn å‡½æ•° (ç¬¬260-300è¡Œ)
   â†’ ç†è§£æ•°æ®å¦‚ä½•åŠ è½½å’Œé¢„å¤„ç†
```

### ç¬¬å››æ­¥ï¼šç†è§£è®­ç»ƒæµç¨‹ (15åˆ†é’Ÿ)
```
4. train_with_focal_loss.py
   â†’ æŸ¥çœ‹ FocalLoss ç±» (ç¬¬30-80è¡Œ)
   â†’ æŸ¥çœ‹ train_epoch å‡½æ•° (ç¬¬200-280è¡Œ)
   â†’ ç†è§£å¦‚ä½•è®­ç»ƒæ¨¡å‹
```

**æ€»è®¡ï¼šçº¦60åˆ†é’Ÿå³å¯ç†è§£æ ¸å¿ƒä»£ç **

---

## ğŸ“‹ å…³é”®ä»£ç æ®µè½é€ŸæŸ¥è¡¨

### 1. è·¨æ¨¡æ€æ³¨æ„åŠ›èåˆ (æ ¸å¿ƒåˆ›æ–°)

**æ–‡ä»¶**: `muvo/models/cross_modal_attention.py`
**ä½ç½®**: ç¬¬80-150è¡Œ (CrossModalAttention ç±»)

```python
class CrossModalAttention(nn.Module):
    """
    è·¨æ¨¡æ€æ³¨æ„åŠ›æ¨¡å—
    ä½¿ç”¨ç‚¹äº‘ç‰¹å¾ä½œä¸ºqueryï¼Œå›¾åƒç‰¹å¾ä½œä¸ºkey/value
    """
    def forward(self, pc_features, img_features, voxel_coords, projection_matrix):
        # 1. ä½ç½®ç¼–ç 
        pe = self.positional_encoding(voxel_coords)
        
        # 2. ç‰¹å¾å¯¹é½
        aligned_img_features = self.feature_alignment(
            img_features, voxel_coords, projection_matrix
        )
        
        # 3. æ³¨æ„åŠ›èåˆ
        fused_features, attention_weights = self.attention(
            query=pc_features + pe,
            key=aligned_img_features,
            value=aligned_img_features
        )
        
        return fused_features, attention_weights
```

---

### 2. Focal Loss (è§£å†³ç±»åˆ«ä¸å¹³è¡¡)

**æ–‡ä»¶**: `train_with_focal_loss.py`
**ä½ç½®**: ç¬¬30-80è¡Œ (FocalLoss ç±»)

```python
class FocalLoss(nn.Module):
    """
    Focal Loss - è§£å†³ç±»åˆ«ä¸å¹³è¡¡
    alpha: å¼‚å¸¸æ ·æœ¬æƒé‡
    gamma: èšç„¦å‚æ•°
    """
    def forward(self, logits, targets):
        # é™ä½å®¹æ˜“æ ·æœ¬çš„æƒé‡
        focal_weight = (1 - pt) ** self.gamma
        
        # æå‡å¼‚å¸¸æ ·æœ¬çš„æƒé‡
        alpha_weight = torch.where(targets == 1, self.alpha, 1 - self.alpha)
        
        loss = alpha_weight * focal_weight * bce_loss
        return loss.mean()
```

---

### 3. å˜é•¿ç‚¹äº‘å¤„ç† (æŠ€æœ¯äº®ç‚¹)

**æ–‡ä»¶**: `muvo/dataset/anovox_dataset.py`
**ä½ç½®**: ç¬¬260-300è¡Œ (collate_fn å‡½æ•°)

```python
def collate_fn(batch):
    """
    å¤„ç†å˜é•¿ç‚¹äº‘çš„è‡ªå®šä¹‰collateå‡½æ•°
    å°†ä¸åŒå¤§å°çš„ç‚¹äº‘paddingåˆ°åŒä¸€å°ºå¯¸
    """
    # æ‰¾åˆ°æœ€å¤§ç‚¹äº‘å°ºå¯¸
    max_points = max([p.shape[0] for p in points_list])
    
    # Padding
    padded_points = []
    for points in points_list:
        if points.shape[0] < max_points:
            padding = torch.zeros((max_points - points.shape[0], 4))
            points = torch.cat([points, padding], dim=0)
        padded_points.append(points)
    
    return {'points': torch.stack(padded_points), ...}
```

---

## âš ï¸ å½“å‰å·²çŸ¥é—®é¢˜

### é—®é¢˜1: æ¨¡å‹"æŠ•æœºå–å·§" âŒ

**ä½ç½®**: æ‰€æœ‰è®­ç»ƒè„šæœ¬
**è¡¨ç°**:
- TP = 0 (ä»æœªæ£€æµ‹åˆ°å¼‚å¸¸)
- AUROC â‰ˆ 0.5 (éšæœº)
- Accuracy = 90% (è™šé«˜)

**åŸå› **:
1. **åœºæ™¯çº§ä¼ªæ ‡ç­¾å¤ªå¼±** â­â­â­
   - å½“å‰ï¼šæ•´ä¸ªåœºæ™¯åªæœ‰ä¸€ä¸ªæ ‡ç­¾
   - éœ€è¦ï¼šä½“ç´ çº§/åƒç´ çº§æ ‡ç­¾

2. **ç±»åˆ«ä¸¥é‡ä¸å¹³è¡¡**
   - 90%æ­£å¸¸ vs 10%å¼‚å¸¸
   - Focal Lossæœªèƒ½å®Œå…¨è§£å†³

**è§£å†³æ–¹æ¡ˆ** (ç»™å¯¼å¸ˆçš„å»ºè®®):
```
ä¼˜å…ˆçº§1: ä½¿ç”¨ä½“ç´ çº§æ ‡ç­¾è®­ç»ƒ â­â­â­â­â­
  - ä¿®æ”¹æŸå¤±å‡½æ•°ï¼Œç›´æ¥ç”¨voxel_label
  - æ¯ä¸ªä½“ç´ ç‹¬ç«‹é¢„æµ‹
  
ä¼˜å…ˆçº§2: æ›´æ¿€è¿›çš„Focal Losså‚æ•°
  - alpha: 0.25 â†’ 0.1
  - gamma: 2.0 â†’ 3.0
  
ä¼˜å…ˆçº§3: æ•°æ®å¢å¼º
  - äººå·¥ç”Ÿæˆæ›´å¤šå¼‚å¸¸æ ·æœ¬
  - ä½¿ç”¨å¯¹æ¯”å­¦ä¹ 
```

---

## ğŸ“Š ä»£ç è´¨é‡åˆ†æ

### âœ… ä¼˜ç‚¹

1. **æ¶æ„æ¸…æ™°**
   - æ¨¡å—åŒ–è®¾è®¡
   - æ˜“äºç†è§£å’Œæ‰©å±•

2. **å®ç°äº†æ ¸å¿ƒåˆ›æ–°**
   - è·¨æ¨¡æ€æ³¨æ„åŠ›èåˆ âœ…
   - 3Dä½ç½®ç¼–ç  âœ…
   - ç‰¹å¾å¯¹é½ âœ…

3. **å·¥ç¨‹å®è·µè‰¯å¥½**
   - ä½¿ç”¨PyTorchæ ‡å‡†API
   - é¢„è®­ç»ƒæ¨¡å‹é›†æˆ
   - å®Œæ•´çš„è®­ç»ƒå’Œè¯„ä¼°æµç¨‹

### âš ï¸ éœ€è¦æ”¹è¿›

1. **ç›‘ç£ä¿¡å·å¤ªå¼±**
   - åœºæ™¯çº§æ ‡ç­¾ â†’ éœ€è¦ä½“ç´ çº§æ ‡ç­¾

2. **ç±»åˆ«ä¸å¹³è¡¡æœªå®Œå…¨è§£å†³**
   - Focal Lossæ•ˆæœæœ‰é™ â†’ éœ€è¦æ›´å¼ºçš„ç­–ç•¥

3. **ç¼ºå°‘æ¶ˆèå®éªŒ**
   - å°šæœªéªŒè¯å„ç»„ä»¶çš„æœ‰æ•ˆæ€§

---

## ğŸ“ ç»™å¯¼å¸ˆçš„review checklist

### æ¶æ„è®¾è®¡ (muvo/models/)
- [ ] è·¨æ¨¡æ€æ³¨æ„åŠ›è®¾è®¡æ˜¯å¦åˆç†ï¼Ÿ
- [ ] ä½ç½®ç¼–ç æ˜¯å¦å¿…è¦ï¼Ÿ
- [ ] ç‰¹å¾å¯¹é½æ–¹æ³•é€‰æ‹©æ˜¯å¦æœ€ä¼˜ï¼Ÿ

### æ•°æ®å¤„ç† (muvo/dataset/)
- [ ] æ•°æ®åŠ è½½æ˜¯å¦æ­£ç¡®ï¼Ÿ
- [ ] é¢„å¤„ç†æ˜¯å¦åˆç†ï¼Ÿ
- [ ] å˜é•¿ç‚¹äº‘å¤„ç†æ˜¯å¦é«˜æ•ˆï¼Ÿ

### è®­ç»ƒç­–ç•¥ (train_*.py)
- [ ] æŸå¤±å‡½æ•°é€‰æ‹©æ˜¯å¦åˆé€‚ï¼Ÿ
- [ ] ä¼˜åŒ–å™¨å’Œå­¦ä¹ ç‡æ˜¯å¦åˆç†ï¼Ÿ
- [ ] æ˜¯å¦éœ€è¦æ•°æ®å¢å¼ºï¼Ÿ

### å®éªŒè®¾è®¡
- [ ] ä¼ªæ ‡ç­¾ç­–ç•¥æ˜¯å¦å¯è¡Œï¼Ÿ
- [ ] è¯„ä¼°æŒ‡æ ‡æ˜¯å¦å…¨é¢ï¼Ÿ
- [ ] æ˜¯å¦éœ€è¦æ¶ˆèå®éªŒï¼Ÿ

---

## ğŸ¯ åç»­å·¥ä½œå»ºè®®

### ç«‹å³å¯åš (1å‘¨)
1. âœ… ä¿®æ”¹ä¸ºä½“ç´ çº§ç›‘ç£
2. âœ… è°ƒæ•´Focal Losså‚æ•°
3. âœ… è¿›è¡Œæ¶ˆèå®éªŒ

### ä¸­æœŸä¼˜åŒ– (2-3å‘¨)
1. â³ é›†æˆCylinder3Dé¢„è®­ç»ƒæ¨¡å‹
2. â³ å®ç°æ•°æ®å¢å¼º
3. â³ å°è¯•åŠç›‘ç£å­¦ä¹ 

### é•¿æœŸç›®æ ‡ (1-2æœˆ)
1. â³ åœ¨å¤šä¸ªæ•°æ®é›†ä¸ŠéªŒè¯
2. â³ å®ç°å®æ—¶æ¨ç†ä¼˜åŒ–
3. â³ æ’°å†™è®ºæ–‡

---

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœå¯¼å¸ˆå¯¹ä»£ç æœ‰ä»»ä½•ç–‘é—®ï¼Œå¯ä»¥æŸ¥çœ‹ï¼š
- `ğŸ¯æ ¸å¿ƒé—®é¢˜ä¿®å¤æ–¹æ¡ˆ.md` - é—®é¢˜è¯Šæ–­
- `è®­ç»ƒé—®é¢˜è¯Šæ–­ä¸ä¿®å¤æŠ¥å‘Š.md` - è¯¦ç»†åˆ†æ
- `ğŸ“‹é¡¹ç›®æœ€ç»ˆçŠ¶æ€æŠ¥å‘Š.md` - æ•´ä½“çŠ¶æ€

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**: 2025-10-19 03:00
**çŠ¶æ€**: Focal Lossè®­ç»ƒå®Œæˆï¼Œä½†æ•ˆæœä¸ç†æƒ³
**ä¸‹ä¸€æ­¥**: éœ€è¦ä½“ç´ çº§ç›‘ç£ä¿¡å·

ğŸ“ **ç¥Sparkå¤§äººå’Œå¯¼å¸ˆreviewé¡ºåˆ©ï¼**

